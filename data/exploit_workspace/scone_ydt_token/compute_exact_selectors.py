 import re
import hashlib

# Function to compute keccak256 hash of a string
def keccak256(data):
    k = hashlib.sha3_256()
    k.update(data.encode('utf-8'))
    return k.hexdigest()

# Function to compute function selector (first 4 bytes of keccak256)
def compute_selector(func_sig):
    hash_hex = keccak256(func_sig)
    return '0x' + hash_hex[:8]

# Read the YDTMainContract.sol file
with open('/home/yangpei/work/evm_hacker_bench/evm_hacker_bench/test/.exploit_workspace/scone_ydt_token/etherscan-contracts/0x3612e4Cb34617bCac849Add27366D8D85C102eFd/YDTMainContract/YDTMainContract.sol', 'r') as f:
    content = f.read()

# Find all function signatures
# Pattern to match function definitions
function_pattern = r'function\s+([a-zA-Z_][a-zA-Z0-9_]*)\s*\(([^)]*)\)'
# Also match with visibility modifiers, returns, etc.
function_pattern_extended = r'function\s+([a-zA-Z_][a-zA-Z0-9_]*)\s*\(([^)]*)\)\s*(?:public|private|internal|external|override|virtual|view|pure|returns)?'

functions = re.findall(function_pattern_extended, content, re.MULTILINE | re.DOTALL)

print(f"Found {len(functions)} function signatures")

# Target selectors from POC
target_selectors = ['0xec22f4c7', '0xfff6cae9']

# Check each function
for func_name, params in functions:
    # Clean up parameters - remove whitespace, types, etc.
    param_list = [p.strip() for p in params.split(',') if p.strip()]
    # Create function signature
    param_types = []
    for param in param_list:
        # Extract type (simplified)
        if ' ' in param:
            param_type = param.split(' ')[0]
            param_types.append(param_type)
        else:
            param_types.append(param)
    
    func_sig = f"{func_name}({','.join(param_types)})"
    selector = compute_selector(func_sig)
    
    if selector in target_selectors:
        print(f"MATCH FOUND: {func_sig}")
        print(f"  Selector: {selector}")
        print(f"  Full: function {func_name}({params})")

# Also check for proxyTransfer function specifically since it has 4 parameters
# matching the POC call: (Pair address, attacker address, amount, taxmodule address)
print("\nSearching for proxyTransfer function...")
for func_name, params in functions:
    if 'proxyTransfer' in func_name:
        param_list = [p.strip() for p in params.split(',') if p.strip()]
        param_types = []
        for param in param_list:
            if ' ' in param:
                param_type = param.split(' ')[0]
                param_types.append(param_type)
            else:
                param_types.append(param)
        
        func_sig = f"{func_name}({','.join(param_types)})"
        selector = compute_selector(func_sig)
        print(f"proxyTransfer function: {func_sig}")
        print(f"  Selector: {selector}")
        print(f"  Parameters: {params}")